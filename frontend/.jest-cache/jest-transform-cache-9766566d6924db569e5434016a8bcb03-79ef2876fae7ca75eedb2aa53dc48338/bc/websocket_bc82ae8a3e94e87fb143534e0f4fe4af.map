{"version":3,"sources":["/Users/jacobhornsvennevik/Documents/GitHub/maRepo_root/frontend/src/lib/websocket.ts"],"sourcesContent":["/**\n * WebSocket service for real-time study progress updates.\n */\nimport { AuthService } from '@/app/(auth)/services/auth';\nimport { WEBSOCKET_CONFIG } from '@/constants/design-tokens';\n\nexport interface StudyProgressUpdate {\n  flashcard_id: string;\n  rating: number;\n  next_review?: string;\n  progress_stats: {\n    total_cards: number;\n    reviewed_today: number;\n    due_cards: number;\n    study_streak: number;\n    completion_rate: number;\n  };\n  timestamp?: string;\n}\n\nexport interface ProjectUpdate {\n  id: string;\n  name: string;\n  type: string;\n  created_at: string;\n}\n\nexport class WebSocketService {\n  private socket: WebSocket | null = null;\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = WEBSOCKET_CONFIG.MAX_RECONNECT_ATTEMPTS;\n  private reconnectDelay = WEBSOCKET_CONFIG.RECONNECT_DELAY;\n  private reconnectTimer: NodeJS.Timeout | null = null;\n\n  constructor() {\n    // Temporarily disable auto-connect until Django Channels is properly configured\n    // this.connect();\n  }\n\n  private connect(): void {\n    if (!AuthService.isAuthenticated()) {\n      console.log('ðŸ”Œ WebSocket: Not authenticated, skipping connection');\n      return;\n    }\n\n    const token = AuthService.getAuthToken();\n    if (!token) {\n      console.log('ðŸ”Œ WebSocket: No auth token available');\n      return;\n    }\n\n    try {\n      // Use Django Channels WebSocket endpoint\n      const wsUrl = `ws://localhost:8000/ws/study-progress/`;\n      this.socket = new WebSocket(wsUrl);\n\n      this.setupEventHandlers();\n      console.log('ðŸ”Œ WebSocket: Connected successfully');\n    } catch (error) {\n      console.error('ðŸ”Œ WebSocket: Connection failed:', error);\n      this.handleReconnect();\n    }\n  }\n\n  private setupEventHandlers(): void {\n    if (!this.socket) return;\n\n    this.socket.onopen = () => {\n      console.log('ðŸ”Œ WebSocket: Connected');\n      this.reconnectAttempts = 0;\n      \n      // Send authentication token\n      const token = AuthService.getAuthToken();\n      if (token) {\n        this.socket?.send(JSON.stringify({\n          type: 'auth',\n          token: token\n        }));\n      }\n    };\n\n    this.socket.onclose = (event) => {\n      console.log('ðŸ”Œ WebSocket: Disconnected:', event.code, event.reason);\n      if (event.code !== 1000) { // Not a normal closure\n        this.handleReconnect();\n      }\n    };\n\n    this.socket.onerror = (error) => {\n      console.error('ðŸ”Œ WebSocket: Connection error:', error);\n      this.handleReconnect();\n    };\n\n    this.socket.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        console.log('ðŸ“Š WebSocket message received:', data);\n        \n        // Handle different message types\n        switch (data.type) {\n          case 'study_progress_update':\n            this.dispatchCustomEvent('study-progress-update', data.data);\n            break;\n          case 'initial_stats':\n            this.dispatchCustomEvent('initial-study-stats', data.data);\n            break;\n          case 'progress_update':\n            this.dispatchCustomEvent('progress-update', data.data);\n            break;\n          case 'project_created':\n            this.dispatchCustomEvent('project-created', data.data);\n            break;\n          case 'project_updated':\n            this.dispatchCustomEvent('project-updated', data.data);\n            break;\n          case 'file_processing_update':\n            this.dispatchCustomEvent('file-processing-update', data.data);\n            break;\n          case 'pong':\n            console.log('ðŸ“ WebSocket: Pong received');\n            break;\n          default:\n            console.log('ðŸ“Š Unknown message type:', data.type);\n        }\n      } catch (error) {\n        console.error('ðŸ”Œ WebSocket: Error parsing message:', error);\n      }\n    };\n  }\n\n  private handleReconnect(): void {\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n      console.error('ðŸ”Œ WebSocket: Max reconnection attempts reached');\n      return;\n    }\n\n    this.reconnectAttempts++;\n    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);\n    \n    console.log(`ðŸ”Œ WebSocket: Reconnecting in ${delay}ms (attempt ${this.reconnectAttempts})`);\n    \n    this.reconnectTimer = setTimeout(() => {\n      this.connect();\n    }, delay);\n  }\n\n  private dispatchCustomEvent(eventName: string, data: any): void {\n    const event = new CustomEvent(eventName, { detail: data });\n    window.dispatchEvent(event);\n  }\n\n  /**\n   * Send flashcard review to server\n   */\n  public reviewFlashcard(flashcardId: string, rating: number): void {\n    if (!this.socket || this.socket.readyState !== WebSocket.OPEN) {\n      console.warn('ðŸ”Œ WebSocket: Not connected, cannot send review');\n      return;\n    }\n\n    this.socket.send(JSON.stringify({\n      type: 'flashcard_review',\n      flashcard_id: flashcardId,\n      rating: rating\n    }));\n  }\n\n  /**\n   * Request current study progress\n   */\n  public getStudyProgress(): void {\n    if (!this.socket || this.socket.readyState !== WebSocket.OPEN) {\n      console.warn('ðŸ”Œ WebSocket: Not connected, cannot get progress');\n      return;\n    }\n\n    this.socket.send(JSON.stringify({\n      type: 'get_progress'\n    }));\n  }\n\n  /**\n   * Ping server to check connection\n   */\n  public ping(): void {\n    if (!this.socket || this.socket.readyState !== WebSocket.OPEN) {\n      console.warn('ðŸ”Œ WebSocket: Not connected, cannot ping');\n      return;\n    }\n\n    this.socket.send(JSON.stringify({\n      type: 'ping'\n    }));\n  }\n\n  /**\n   * Disconnect WebSocket\n   */\n  public disconnect(): void {\n    if (this.reconnectTimer) {\n      clearTimeout(this.reconnectTimer);\n      this.reconnectTimer = null;\n    }\n    \n    if (this.socket) {\n      this.socket.close(1000, 'Client disconnect');\n      this.socket = null;\n      console.log('ðŸ”Œ WebSocket: Disconnected');\n    }\n  }\n\n  /**\n   * Check if WebSocket is connected\n   */\n  public isConnected(): boolean {\n    // Temporarily return false until Django Channels is properly configured\n    return false;\n  }\n\n  /**\n   * Reconnect WebSocket\n   */\n  public reconnect(): void {\n    this.disconnect();\n    this.reconnectAttempts = 0;\n    this.connect();\n  }\n}\n\n// Singleton instance\nexport const webSocketService = new WebSocketService();\n\n// Export hook for React components\nexport function useWebSocket() {\n  return webSocketService;\n}\n"],"names":["WebSocketService","useWebSocket","webSocketService","constructor","socket","reconnectAttempts","maxReconnectAttempts","WEBSOCKET_CONFIG","MAX_RECONNECT_ATTEMPTS","reconnectDelay","RECONNECT_DELAY","reconnectTimer","connect","AuthService","isAuthenticated","console","log","token","getAuthToken","wsUrl","WebSocket","setupEventHandlers","error","handleReconnect","onopen","send","JSON","stringify","type","onclose","event","code","reason","onerror","onmessage","data","parse","dispatchCustomEvent","delay","Math","pow","setTimeout","eventName","CustomEvent","detail","window","dispatchEvent","reviewFlashcard","flashcardId","rating","readyState","OPEN","warn","flashcard_id","getStudyProgress","ping","disconnect","clearTimeout","close","isConnected","reconnect"],"mappings":"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"}